{"name":"Credit Limit Metafield Update","options":{},"script":"\n\n{% assign company_id = order.company.id %}\n\n{% if company_id %}\n\n{% comment %} TODO: ADD PAGINATION {% endcomment %}\n{% capture query %}\n\n{\n\tcompany(id: \"gid://shopify/Company/{{ company_id }}\") {\n\t\tmetafield(namespace: \"b2b\", key: \"credit_limit\") {\n\t\t\tcredit_limit: value\n\t\t}\n\t\torders(first: 50) {\n\t\t\tedges {\n\t\t\t\tnode {\n\t\t\t\t\tid\n\t\t\t\t\tdisplayFinancialStatus\n\t\t\t\t\ttotalOutstandingSet {\n\t\t\t\t\t\tshopMoney {\n\t\t\t\t\t\t\tamount\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\n{% endcapture %}\n\n{% assign result = query | shopify %}\n\n{% assign orders = result.data.company.orders.edges | map: \"node\" %}\n{% log \"orders: \"%}\n{% log orders %}\n{% assign credit_limit = result.data.company.metafield.credit_limit %}\n{% log \"credit_limit: \" %}\n\t{% log credit_limit %}\n\n{% assign total_outstanding = 0 %}\n\n{% for order in orders%}\n\n{% assign total_outstanding = total_outstanding | plus: order.totalOutstandingSet.shopMoney.amount | floor %}\n\n\t{% endfor %}\n\n{% log \"total_outstanding: \" %}\n\t{% log total_outstanding %}\n\n{% assign credit_limit_remaining = credit_limit | minus: total_outstanding %}\n{% log \"credit_limit_remaining: \" %}\n\n{% log credit_limit_remaining %}\n\n\n{% action \"shopify\" %}\n\nmutation  {\n  metafieldsSet(\n  \tmetafields: [\n\t\t{\n\t\t\tkey: \"credit_limit_remaining\",\n\t\t\tnamespace: \"b2b\",\n\t\t\townerId: \"gid://shopify/Company/{{company_id}}\",\n\t\t\ttype: \"number_integer\",\n\t\t\tvalue: \"{{credit_limit_remaining}}\"\n\t\t}\n\t]\n  ) {\n    metafields {\n      namespace\n\t\tkey\nvalue\n    }\n    userErrors {\n      field\n      message\n    }\n  }\n}\n  {% endaction %}\n\n{% endif %}\n\n","subscriptions":["shopify/orders/create","shopify/orders/paid","shopify/orders/updated"],"online_store_javascript":null,"order_status_javascript":null,"docs":"This task watches for orders for a certain donation product, and tallies up the total donation amount in a store metafield, allowing you to display this value in your online storefront.\n\nThis task runs automatically, whenever an order is paid. To fully recalculate the total donation amount stored, click the \"Run task\" button. Optionally, choose to have this task run the recalculation nightly - useful for making sure that refunds are regularly accounted for.","subscriptions_template":"shopify/orders/create\nshopify/orders/paid\nshopify/orders/updated","shopify_api_version":"2023-07","perform_action_runs_in_sequence":false,"halt_action_run_sequence_on_error":false,"preview_event_definitions":[{"description":"b2b order","event_attributes":{"topic":"shopify/orders/create","data":{"id":4676791599147,"admin_graphql_api_id":"gid://shopify/Order/4676791599147","app_id":1354745,"browser_ip":null,"buyer_accepts_marketing":false,"cancel_reason":null,"cancelled_at":null,"cart_token":null,"checkout_id":26896470540331,"checkout_token":"8bd739a3cf495c4d521729b827521bc2","client_details":{"accept_language":null,"browser_height":null,"browser_ip":null,"browser_width":null,"session_hash":null,"user_agent":null},"closed_at":null,"company":{"id":178782251,"location_id":467861547},"confirmed":true,"contact_email":"justin.brown@shopify.com","created_at":"2023-03-09T10:51:25-05:00","currency":"CAD","current_subtotal_price":"100.00","current_subtotal_price_set":{"shop_money":{"amount":"100.00","currency_code":"CAD"},"presentment_money":{"amount":"100.00","currency_code":"CAD"}},"current_total_discounts":"0.00","current_total_discounts_set":{"shop_money":{"amount":"0.00","currency_code":"CAD"},"presentment_money":{"amount":"0.00","currency_code":"CAD"}},"current_total_duties_set":null,"current_total_price":"100.00","current_total_price_set":{"shop_money":{"amount":"100.00","currency_code":"CAD"},"presentment_money":{"amount":"100.00","currency_code":"CAD"}},"current_total_tax":"0.00","current_total_tax_set":{"shop_money":{"amount":"0.00","currency_code":"CAD"},"presentment_money":{"amount":"0.00","currency_code":"CAD"}},"customer_locale":"en","device_id":null,"discount_codes":[],"email":"justin.brown@shopify.com","estimated_taxes":false,"financial_status":"pending","fulfillment_status":null,"gateway":"manual","landing_site":null,"landing_site_ref":null,"location_id":null,"merchant_of_record_app_id":null,"name":"#1005","note":null,"note_attributes":[],"number":5,"order_number":1005,"order_status_url":"https://shop-b2b-demo.myshopify.com/56580800555/orders/33f2368505f27d9c63107b965c5b3af9/authenticate?key=de7a8e64f5af855971716973e62c2cc4","original_total_duties_set":null,"payment_gateway_names":["manual"],"phone":null,"presentment_currency":"CAD","processed_at":"2023-03-09T10:51:25-05:00","processing_method":"manual","reference":null,"referring_site":null,"source_identifier":null,"source_name":"shopify_draft_order","source_url":null,"subtotal_price":"100.00","subtotal_price_set":{"shop_money":{"amount":"100.00","currency_code":"CAD"},"presentment_money":{"amount":"100.00","currency_code":"CAD"}},"tags":"","tax_lines":[],"taxes_included":false,"test":false,"token":"33f2368505f27d9c63107b965c5b3af9","total_discounts":"0.00","total_discounts_set":{"shop_money":{"amount":"0.00","currency_code":"CAD"},"presentment_money":{"amount":"0.00","currency_code":"CAD"}},"total_line_items_price":"100.00","total_line_items_price_set":{"shop_money":{"amount":"100.00","currency_code":"CAD"},"presentment_money":{"amount":"100.00","currency_code":"CAD"}},"total_outstanding":"100.00","total_price":"100.00","total_price_set":{"shop_money":{"amount":"100.00","currency_code":"CAD"},"presentment_money":{"amount":"100.00","currency_code":"CAD"}},"total_shipping_price_set":{"shop_money":{"amount":"0.00","currency_code":"CAD"},"presentment_money":{"amount":"0.00","currency_code":"CAD"}},"total_tax":"0.00","total_tax_set":{"shop_money":{"amount":"0.00","currency_code":"CAD"},"presentment_money":{"amount":"0.00","currency_code":"CAD"}},"total_tip_received":"0.00","total_weight":0,"updated_at":"2023-03-09T10:51:26-05:00","user_id":77106610219,"customer":{"id":6038900998187,"email":"justin.brown@shopify.com","accepts_marketing":false,"created_at":"2023-03-02T13:09:06-05:00","updated_at":"2023-03-09T10:51:25-05:00","first_name":"Justin","last_name":"Brown","state":"disabled","note":null,"verified_email":true,"multipass_identifier":null,"tax_exempt":false,"tags":"","currency":"CAD","phone":null,"accepts_marketing_updated_at":"2023-03-02T13:09:06-05:00","marketing_opt_in_level":null,"tax_exemptions":[],"email_marketing_consent":{"state":"not_subscribed","opt_in_level":"single_opt_in","consent_updated_at":null},"sms_marketing_consent":null,"admin_graphql_api_id":"gid://shopify/Customer/6038900998187"},"discount_applications":[],"fulfillments":[],"line_items":[{"id":11708408496171,"admin_graphql_api_id":"gid://shopify/LineItem/11708408496171","fulfillable_quantity":1,"fulfillment_service":"manual","fulfillment_status":null,"gift_card":false,"grams":0,"name":"Test Product","price":"100.00","price_set":{"shop_money":{"amount":"100.00","currency_code":"CAD"},"presentment_money":{"amount":"100.00","currency_code":"CAD"}},"product_exists":true,"product_id":7072616087595,"properties":[],"quantity":1,"requires_shipping":true,"sku":"","taxable":false,"title":"Test Product","total_discount":"0.00","total_discount_set":{"shop_money":{"amount":"0.00","currency_code":"CAD"},"presentment_money":{"amount":"0.00","currency_code":"CAD"}},"variant_id":40696632016939,"variant_inventory_management":null,"variant_title":"","vendor":"shop-b2b-demo","tax_lines":[],"duties":[],"discount_allocations":[]}],"payment_terms":{"id":7484506155,"created_at":"2023-03-09T10:51:25-05:00","due_in_days":null,"payment_schedules":[{"id":8362983467,"amount":"100.00","currency":"CAD","issued_at":null,"due_at":null,"completed_at":null,"created_at":"2023-03-09T10:51:25-05:00","updated_at":"2023-03-09T10:51:25-05:00"}],"payment_terms_name":"Due on receipt","payment_terms_type":"receipt","updated_at":"2023-03-09T10:51:25-05:00"},"refunds":[],"shipping_address":{"first_name":null,"address1":"80 William St","phone":null,"city":"Barrie","zip":"L4N 3J7","province":"Ontario","country":"Canada","last_name":"","address2":null,"company":"Justin Inc.","latitude":null,"longitude":null,"name":"","country_code":"CA","province_code":"ON"},"shipping_lines":[]}}}]}